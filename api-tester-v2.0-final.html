<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mark Platform v2.0 Final Validation</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        h1 {
            color: #ea580c;
        }

        h2 {
            color: #ea580c;
            margin-top: 30px;
            border-bottom: 2px solid #ea580c;
            padding-bottom: 5px;
        }

        button {
            background: #ea580c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button.secondary {
            background: #4b5563;
        }

        button:hover {
            opacity: 0.9;
        }

        .result {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            max-height: 300px;
        }

        .success {
            border-left: 4px solid #10b981;
        }

        .error {
            border-left: 4px solid #ef4444;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            margin: 5px 0;
            box-sizing: border-box;
        }

        .row {
            display: flex;
            gap: 10px;
        }

        .col {
            flex: 1;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Mark Platform v2.0 Final Validation</h1>
        <p>End-to-End Test Suite for Go-Live (Phases 1-7)</p>

        <h2>1. Authentication (Security)</h2>
        <div class="row">
            <div class="col"><input type="email" id="email" value="admin@mark.com" placeholder="Email"></div>
            <div class="col"><input type="password" id="password" value="password123" placeholder="Password"></div>
        </div>
        <button onclick="login()">Login as Admin</button>
        <div id="loginResult"></div>

        <h2>2. Student Management (Batch Import + Schema)</h2>
        <p>Test imports using new Phase 7 fields (Grade, Enrollment ID).</p>
        <textarea id="importData" rows="5">
{
    "students": [
        {
            "name": "Test Student A",
            "email": "student.a@mark.com",
            "enrollmentId": "2024-A01",
            "grade": "9th Grade A",
            "guardianEmail": "parent.a@test.com"
        }
    ]
}
        </textarea>
        <button onclick="testImport()">Run Batch Import</button>
        <div id="importResult"></div>

        <h2>3. Data Intelligence (Analytics)</h2>
        <p>Verify Engagement Scores and Class Rankings.</p>
        <button onclick="testPerformance()">Fetch Class Analytics</button>
        <div id="performanceResult"></div>

        <h2>4. Financials & Governance</h2>
        <p>Verify Financial Dashboard and Expiration Emails.</p>
        <button onclick="testFinancial()">Fetch Financials</button>
        <button class="secondary" onclick="testExpiration()">Test Expiration Cron (Mock Email)</button>
        <div id="financialResult"></div>
    </div>

    <script>
        const FUNCTIONS_URL = 'https://cqrjiaskaperrmfiuewd.supabase.co/functions/v1';
        const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNxcmppYXNrYXBlcnJtZml1ZXdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MjkwMDUsImV4cCI6MjA3NjEwNTAwNX0.GbRCx97w6WQEQ4TKozB9tQxhAu6yMVVtFkoDypmlAiY';
        let userToken = null;

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('loginResult');
            resultDiv.innerHTML = 'Logging in...';
            try {
                const response = await fetch(`${FUNCTIONS_URL}/auth-login-v2`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}`, 'apikey': ANON_KEY },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                if (data.token) {
                    userToken = data.token;
                    resultDiv.innerHTML = `<div class="result success"><strong>Success!</strong> Token acquired.<br>User: ${data.user.email} (${data.user.role})</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="result error">Failed: ${JSON.stringify(data)}</div>`;
                }
            } catch (e) { resultDiv.innerHTML = `<div class="result error">${e.message}</div>`; }
        }

        async function testImport() {
            if (!userToken) return alert('Login first');
            const resultDiv = document.getElementById('importResult');
            const body = document.getElementById('importData').value;
            resultDiv.innerHTML = 'Importing...';
            try {
                const response = await fetch(`${FUNCTIONS_URL}/students-batch-import`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}`, 'apikey': ANON_KEY },
                    body: body
                });
                const data = await response.json();
                resultDiv.innerHTML = `<div class="result ${data.error ? 'error' : 'success'}"><pre>${JSON.stringify(data, null, 2)}</pre></div>`;
            } catch (e) { resultDiv.innerHTML = `<div class="result error">${e.message}</div>`; }
        }

        async function testPerformance() {
            if (!userToken) return alert('Login first');
            const resultDiv = document.getElementById('performanceResult');
            resultDiv.innerHTML = 'Fetching Metrics...';
            try {
                const response = await fetch(`${FUNCTIONS_URL}/schools-analytics-performance`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}`, 'apikey': ANON_KEY }
                });
                const data = await response.json();
                resultDiv.innerHTML = `<div class="result ${data.error ? 'error' : 'success'}"><pre>${JSON.stringify(data, null, 2)}</pre></div>`;
            } catch (e) { resultDiv.innerHTML = `<div class="result error">${e.message}</div>`; }
        }

        async function testFinancial() {
            if (!userToken) return alert('Login first');
            const resultDiv = document.getElementById('financialResult');
            resultDiv.innerHTML = 'Fetching Financials...';
            try {
                const response = await fetch(`${FUNCTIONS_URL}/schools-analytics-financial`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}`, 'apikey': ANON_KEY }
                });
                const data = await response.json();
                resultDiv.innerHTML = `<div class="result ${data.error ? 'error' : 'success'}"><pre>${JSON.stringify(data, null, 2)}</pre></div>`;
            } catch (e) { resultDiv.innerHTML = `<div class="result error">${e.message}</div>`; }
        }

        async function testExpiration() {
            // Requires CRON SECRET usually, but we can verify code exists or try calling it if allowed
            // Actually, we can't call cron directly usually without secret header. 
            // We will skip actual call and rely on unit tests or just show message.
            alert('Cron jobs execute automatically. Please verify logs in Supabase Dashboard.');
        }
    </script>
</body>

</html>